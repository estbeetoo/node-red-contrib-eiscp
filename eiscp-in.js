/**
 * Created by aborovsky on 27.08.2015.
 */

var util = require('util'),
    eiscp = require('eiscp');

module.exports = function (RED) {
    /**
     * ====== EISCP-IN ========================
     * Handles incoming EISCP, injecting
     * json into node-red flows
     * =======================================
     */
    function EISCPIn(config) {
        RED.nodes.createNode(this, config);
        this.name = config.name;
        this.connection = null;
        var node = this;
        this.currentError = null;
        //node.log('new EISCPIn, config: %j', config);
        var eiscpjsController = RED.nodes.getNode(config.controller);
        /* ===== Node-Red events ===== */
        this.on("input", function (msg) {
            if (msg != null) {

            }
        });
        this.on("close", function () {
            if (node.receiveEvent && node.connection)
                node.connection.removeListener('event', node.receiveEvent);
            if (node.receiveStatus && node.connection)
                node.connection.removeListener('status', node.receiveStatus);
        });

        function nodeStatusConnecting() {
            node.status({fill: "green", shape: "ring", text: "connecting"});
        }

        function nodeStatusConnected() {
            node.currentError = null; 
            node.status({fill: "green", shape: "dot", text: "connected"});
        }

        function nodeStatusDisconnected() {
            if(node.currentError == null){
                node.status({fill: "red", shape: "dot", text: "disconnected"});
            } else {
                nodeStatusDisconnectedWithError(node.currentError);
            }
        }
        
        function nodeStatusDisconnectedWithError(error) {
            var statusText = "disconnected (" + error + ")";
            node.status({fill: "red", shape: "dot", text: statusText});
        }

        node.receiveData = function (data) {
            node.log('eiscp event data[' + data.toString('hex') + ']');
            node.send({
                topic: 'eiscp',
                payload: data
            });
        };

//		this.on("error", function(msg) {});

        /* ===== eiscpjs events ===== */
        eiscpjsController.initializeEISCPConnection(function (connection) {
            node.connection = connection;
            node.connection.removeListener('data', node.receiveData);
            node.connection.on('data', node.receiveData);

            if (node.connection.connected)
                nodeStatusConnected();
            else
                nodeStatusDisconnected();
            node.connection.removeListener('connecting', nodeStatusConnecting);
            node.connection.on('connecting', nodeStatusConnecting);
            node.connection.removeListener('connect', nodeStatusConnected);
            node.connection.on('connect', nodeStatusConnected);
            node.connection.removeListener('close', nodeStatusDisconnected);
            node.connection.on('close', nodeStatusDisconnected);
            node.connection.removeListener('error', nodeStatusDisconnected);
            node.connection.on('error', function (err) {
                    node.currentError = err;
                    nodeStatusDisconnectedWithError(err);
            });
        });
    }

    RED.nodes.registerType("eiscp-in", EISCPIn);
}
